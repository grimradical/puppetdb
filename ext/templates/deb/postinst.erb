#!/bin/sh

set -e

if [ "$1" = "configure" ]; then

    # Create the "<%= @name -%>" user
    if ! getent passwd <%= @name -%>  > /dev/null; then
        adduser --quiet --system --group --home <%= @install_dir -%>  \
            --no-create-home                                 \
            --gecos "Puppet StoredConfigs daemon" \
            <%= @name %>
    fi

    # Create the "<%= @name -%>" group, if it is missing, and set the
    # primary group of the "<%= @name -%>" user to this group.
    if ! getent group <%= @name -%> > /dev/null; then
         addgroup --quiet --system <%= @name %>
         usermod -g <%= @name -%> <%= @name %>
    fi

    # Set correct permissions and ownership for puppetdb directories
    if ! dpkg-statoverride --list <%= @log_dir -%> >/dev/null 2>&1; then
        dpkg-statoverride --update --add <%= @name -%>  <%= @name -%> 0750 <%= @log_dir %>
    fi

    if ! dpkg-statoverride --list <%= @install_dir -%> >/dev/null 2>&1; then
        dpkg-statoverride --update --add <%= @name -%>  <%= @name -%> 0700 <%= @install_dir %>
    fi

    if ! dpkg-statoverride --list <%= @config_dir -%> >/dev/null 2>&1; then
        dpkg-statoverride --update --add <%= @name -%>  <%= @name -%> 0700 <%= @config_dir %>
    fi
fi

#DEBHELPER#
